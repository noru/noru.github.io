{"componentChunkName":"component---src-templates-tag-tsx","path":"/tags/animation","webpackCompilationHash":"4e3c0545dd6191cd3daf","result":{"pageContext":{"isCreatedByStatefulCreatePages":false,"posts":[{"excerpt":"最近在把前面做的几个视(wan)觉(piao)向的代码迁出到新的 repo , 并添加了一些新的效果. 除了巩固了一下 Canvas API 和高中三角函数知识外, 还是学到了若干 Tricks. 其中一个是 Canvas 的尾迹效果, 或者说淡出(fade out)效果. 如果独立思考的话, 首先想到的方法大概是: 缓存上一帧 Canvas 在渲染当前帧之前, 先把缓存帧加一个 alpha 值并绘制在 Canvas 上 继续当前帧所有元素的绘制 但这个方法的问题是, Canvas…","html":"<p>最近在把前面做的几个视(wan)觉(piao)向的代码迁出到新的<a href=\"https://github.com/noru/visual-effects\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">repo</a>, 并添加了一些新的效果. 除了巩固了一下 Canvas API 和高中三角函数知识外, 还是学到了若干 Tricks. 其中一个是 Canvas 的尾迹效果, 或者说淡出(fade out)效果.</p>\n<p><img src=\"/assets/image/canvas-trails.png\" alt=\"example\"></p>\n<hr>\n<p>如果独立思考的话, 首先想到的方法大概是:</p>\n<ul>\n<li>缓存上一帧 Canvas</li>\n<li>在渲染当前帧之前, 先把缓存帧加一个 alpha 值并绘制在 Canvas 上</li>\n<li>继续当前帧所有元素的绘制</li>\n</ul>\n<p>但这个方法的问题是, Canvas 的<code class=\"language-text\">Context</code>并没有类似接口可以利用. 本以为<code class=\"language-text\">globalAlpha</code>可以做到类似效果, 但其实这并不能影响已绘像素. 所以不免要用到<code class=\"language-text\">getImageData</code>.</p>\n<p>再继续深入下去之前, 发现前人解决方法竟是非常简单:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Draw a \"chiffon\" over the whole canvas to create the trail effect</span>\n  context<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> <span class=\"token string\">'rgba(255, 255, 255, .05)'</span> <span class=\"token comment\">// using background color with an alpha</span>\n  context<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Draw things as usually...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>翻译: 在绘制每一帧之前, 施加一层带透明度的背景色, 来模拟过去帧的淡出效果.</p>\n<p>除了无法分区和需要事先知道背景色之外, 似乎这是个聪明无破绽的方法. 但实际上海有个很大问题: <strong>轨迹会停留在一个接近背景色的颜色上, 但不会完全变为背景色.</strong></p>\n<p><img src=\"/assets/image/water-stain.png\" alt=\"water-stain\"></p>\n<p>经过一番调查, 这篇<a href=\"http://rectangleworld.com/blog/archives/214\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Blog</a>很好的解释了的可能的原因: alpha 值再由浮点数转为 0-255 的整数时, 由于采用了类似<code class=\"language-text\">Math.ceil</code>的向上取整, 会导致停留在一个整数上, 例如:</p>\n<p><code class=\"language-text\">5 * 0.9 -&gt; 4.5(5) * 0.9 -&gt; 4.5(5) * 0.9...</code></p>\n<p>另外一个证据就是, 使用开头提到的多层 Canvas + globalAlpha 的方法, 也会出现一样的效果. 并且指出 Chrome 的早期版本, 区别于 IE 和 Firefox, 是可以完全淡出的. 至于后面为什么又改回来了, 不排除是故意而为之.</p>\n<hr>\n<h3 id=\"那么有没有\"><a href=\"#%E9%82%A3%E4%B9%88%E6%9C%89%E6%B2%A1%E6%9C%89\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>那么有没有...</h3>\n<p><strong>有!</strong></p>\n<p>单单要想解决这一个残影问题, 方法还是有的:</p>\n<ul>\n<li>在不改变透明覆盖层颜色的情况下, 把背景色调整为与残影颜色一致即可. <a href=\"https://blog.xiuz.hu/visual-effects\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">例子</a>中就采用了这种简单粗暴的办法.</li>\n<li>使用真\"轨迹\", 记录元素的\"过去\"M 帧的状态, 当做正常帧来绘制. 好处是可以仅为需要施加效果的元素做处理. 坏处是时间复杂度 O(元素个数) -> O(元素个数*淡出所需帧数). 并且复杂情况下缓存的数据可能不止位置信息, 空间复杂度上升同样需要注意. <a href=\"https://www.kirupa.com/canvas/creating_motion_trails.htm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">这篇 Blog</a>介绍了一个简单的例子.</li>\n<li>使用<code class=\"language-text\">getImageData</code>, 用整形操作 alpha 值. 但如此即抛弃了 GPU 加速的可能, 立刻提升 CPU 负载.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> lastFrame <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getImageData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> lastFrame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  pixelData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">-=</span> <span class=\"token number\">3</span> <span class=\"token comment\">// &lt;- no rounding problem</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2 id=\"总结\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>以上各种方法, 还说得过去, 可以根据实际情况选择使用. 看上去完美的 Canvas 拖尾淡出效果目前还不存在. 也许这应该是 WebGL 的领域, Canvas 并不是非常关心类似的操作, 也不大可能期待未来有接口上的动作.</p>","id":"bd366377-611e-5def-898b-5fcff05bac0b","fields":{"slug":"canvas拖尾效果-trails-effect"},"frontmatter":{"date":"2019-08-29","title":"Canvas拖尾效果(Trails Effect)","category":"Code","tags":["canvas","animation","web","js"],"banner":"/assets/image/canvas-trails.png"},"timeToRead":2},{"excerpt":"Talk is cheap, show me the   想尝试这个玩意很久了. 早先听一个 独立游戏开发者讲自己心路历程 , 提到了自己一直维护的消除类游戏并赚点小钱的故事. 就像一道上好的面试题一样, 切入起来很简单,  要多少有多少要多深有多深. 整个实现过程也没什么好说的, 都是可以预见情况. 设计和实现并无什么优劣之分, 毕竟只是最小实现, 50…","html":"<p><strong>Talk is cheap, show me the</strong> <a href=\"https://github.com/noru/3-match\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"https://img.shields.io/github/forks/noru/3-match.svg?label=Souce%20Code&#x26;style=social#nopreview\" alt=\"GitHub\"></a></p>\n<iframe src=\"https://blog.xiuz.hu/3-match/dist/index.html\" frameBorder=\"0\" width=\"100%\" height=\"500\" style=\"max-width:600px;margin-left:50%;transform:translateX(-50%);overflow:hidden;\"></iframe>\n<p>想尝试这个玩意很久了. 早先听一个<a href=\"https://www.youtube.com/watch?v=JmwbYl6f11c\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">独立游戏开发者讲自己心路历程</a>, 提到了自己一直维护的消除类游戏并赚点小钱的故事. 就像一道上好的面试题一样, 切入起来很简单, <code class=\"language-text\">follow up</code>要多少有多少要多深有多深.</p>\n<p>整个实现过程也没什么好说的, 都是可以预见情况. 设计和实现并无什么优劣之分, 毕竟只是最小实现, 500 行左右的代码. 无非是锻炼了在没有蓝图没有依赖库的情况下, 从头到尾自己<code class=\"language-text\">follow through</code>的意志力. 因为并不是想要实现一个完整可玩的游戏, 所以很多锦上添花的东西, 如计分系统之类, 均不予考虑.</p>\n<p>几个早就知道的...</p>\n<h3 id=\"take-away\"><a href=\"#take-away\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Take away</h3>\n<ul>\n<li><strong>Unit test 的重要性.</strong> 三消是一个典型的业务逻辑简单的项目, 但内在实现如何兼顾健壮和效率并不简单. 保证核心功能的稳健前进, UT 是不可替代的. 回头看, 因为写了 UT, 后续功能可以放心推进; 因为 UT 测试用例不全, 犯了非对称棋盘时消除判定的低级错误, 直到最后才发现.</li>\n<li><strong>Typing 的重要性.</strong> 同上. 没有类型 == 浪费生命.</li>\n<li><strong>FP 也不是都比 OO 强.</strong> riot 的面试官问过这个两者比较的问题. 由于英语上表达的问题, 感觉当时我的答案就是 FP > OO. 其实, 即使有这方面倾向但我也知道对于游戏这类强交互重性能场景下, OO 还是无法替代的, 只是没有表达出来. 特定场景下的设计模式还是需要学习和积累经验, 比如游戏上的<code class=\"language-text\">Loop</code>和<code class=\"language-text\">Event Driven</code>框架.</li>\n</ul>\n<h2 id=\"更新一波\"><a href=\"#%E6%9B%B4%E6%96%B0%E4%B8%80%E6%B3%A2\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>更新一波</h2>\n<p>经本人脑残粉提醒: 没 BGM. 办公室里偷摸打酱油的环境让我忘了这么重要的事情, 特此加入音效及 BGM. 素材来自<a href=\"http://www.aigei.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">爱给网</a>, 特别感谢!</p>","id":"b62cf57e-1e5c-5fec-be5f-158578bdb24f","fields":{"slug":"3-消游戏简易web实现"},"frontmatter":{"date":"2019-07-19","title":"3消游戏简易web实现","category":"Code","tags":["game","animation","web","js"],"banner":"/assets/image/3-match.png"},"timeToRead":1},{"excerpt":"注: 本页的 demo 需要较新的浏览器(推荐 Chrome70+)才能正常执行 大概<妇联 4>上映的时候, google 也上线了一个 无限手套的特效(点此链接再点屏幕右侧的手套) . 搜索结果中的条目, 随机的一半机会随风消逝, 同时附加一些屏幕滚动以及搜索总数目的变化. 除了敬佩还是敬佩! 从那时就有了复刻一下这个效果的想法. 简单考察了一下, 控制台打出了 的 log…","html":"<h4 id=\"注-本页的-demo-需要较新的浏览器推荐-chrome70才能正常执行\"><a href=\"#%E6%B3%A8-%E6%9C%AC%E9%A1%B5%E7%9A%84-demo-%E9%9C%80%E8%A6%81%E8%BE%83%E6%96%B0%E7%9A%84%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8E%A8%E8%8D%90-chrome70%E6%89%8D%E8%83%BD%E6%AD%A3%E5%B8%B8%E6%89%A7%E8%A1%8C\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>注: 本页的 demo 需要较新的浏览器(推荐 Chrome70+)才能正常执行</h4>\n<p>大概&#x3C;妇联 4>上映的时候, google 也上线了一个<a href=\"https://www.google.com/search?q=infinity+gauntlet&#x26;oq=infinity+gauntlet\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">无限手套的特效(点此链接再点屏幕右侧的手套)</a>. 搜索结果中的条目, 随机的一半机会随风消逝, 同时附加一些屏幕滚动以及搜索总数目的变化. 除了敬佩还是敬佩! 从那时就有了复刻一下这个效果的想法.</p>\n<p>简单考察了一下, 控制台打出了<code class=\"language-text\">html2canvas</code>的 log, 也指明了主要技术方向. 其他方面, 由于有随机性加持, 也没看出什么端倪, 只好自己想办法.</p>\n<h3 id=\"已知\"><a href=\"#%E5%B7%B2%E7%9F%A5\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>已知</h3>\n<ul>\n<li>屏幕元素是通过<code class=\"language-text\">html2canvas</code>转为<code class=\"language-text\">canvas</code>或至少为图像数据</li>\n<li>动画是通过<code class=\"language-text\">canvas</code>完成</li>\n</ul>\n<p>于是主要问题出现...</p>\n<h3 id=\"如何在-canvas-上实现粒子的运动\"><a href=\"#%E5%A6%82%E4%BD%95%E5%9C%A8-canvas-%E4%B8%8A%E5%AE%9E%E7%8E%B0%E7%B2%92%E5%AD%90%E7%9A%84%E8%BF%90%E5%8A%A8\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>如何在 canvas 上实现粒子的运动</h3>\n<p><code class=\"language-text\">canvas</code>的 api 极其底层, 这里也不打算使用第三方库来省事. 于是最容易想到的方案就是: 暴力渲染. 经查, <code class=\"language-text\">getImageData</code>和<code class=\"language-text\">putImageData</code>两个 API 可以实现对图像的截取以及填充. 那么剩下的步骤就简单了</p>\n<ol>\n<li>把已经加载的 canvas 图像分割成粒子, 存储起来</li>\n<li>在动画阶段, 逐帧执行: 擦除整个 canvas -> 计算粒子位置 -> 回填粒子 -> 执行前两步直到遍历所有粒子</li>\n<li>适当时刻结束动画</li>\n</ol>\n<p>这里有一个问题: 所有动画效果都无法超出 canvas 的范围. 不过, 先来实现它吧.</p>\n<h4 id=\"code-classlanguage-textparticalizecode-切割图片为粒子的集合\"><a href=\"#code-classlanguage-textparticalizecode-%E5%88%87%E5%89%B2%E5%9B%BE%E7%89%87%E4%B8%BA%E7%B2%92%E5%AD%90%E7%9A%84%E9%9B%86%E5%90%88\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">particalize()</code> 切割图片为粒子的集合</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">particalize</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> width <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> height <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> canvas <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>canvas\n  <span class=\"token keyword\">let</span> particals <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">let</span> cols <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>rows <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> wholeImage <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getImageData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span> x <span class=\"token operator\">+=</span> width<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    cols <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span> y <span class=\"token operator\">+=</span> height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      rows <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n      <span class=\"token comment\">// using getImageData() for every partical, slower</span>\n      <span class=\"token comment\">// let imgData = ctx.getImageData(x, y, width, height)</span>\n      <span class=\"token comment\">// if (imgData.data[3] === 0) {</span>\n      <span class=\"token comment\">//   continue // ignore transparent particals</span>\n      <span class=\"token comment\">// }</span>\n      <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token function\">clapData</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> wholeImage<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span> <span class=\"token comment\">// ignore transparent particals</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">let</span> imgData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ImageData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span>\n      particals<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> imgData<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">,</span> cols<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>particals<span class=\"token punctuation\">,</span> cols<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h4 id=\"code-classlanguage-textanimatecode-计算位置并回填粒子实现动画\"><a href=\"#code-classlanguage-textanimatecode-%E8%AE%A1%E7%AE%97%E4%BD%8D%E7%BD%AE%E5%B9%B6%E5%9B%9E%E5%A1%AB%E7%B2%92%E5%AD%90%E5%AE%9E%E7%8E%B0%E5%8A%A8%E7%94%BB\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">animate()</code> 计算位置并回填粒子实现动画</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> currentFrame <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">let</span> endFrame <span class=\"token operator\">=</span> <span class=\"token number\">15</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">animate</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> particals<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n  currentFrame <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">let</span> stripHeight <span class=\"token operator\">=</span> rows <span class=\"token operator\">/</span> <span class=\"token number\">8</span>\n  <span class=\"token keyword\">let</span> alpha <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> currentFrame <span class=\"token operator\">/</span> endFrame<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">255</span>\n  particals<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> imgData<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">,</span> col<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> p\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> imgData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      imgData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> alpha\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">let</span> dx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      dy <span class=\"token operator\">=</span> <span class=\"token function\">randomInt</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>rows <span class=\"token operator\">/</span> stripHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">4</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">6</span><span class=\"token punctuation\">:</span>\n        dx <span class=\"token operator\">=</span> <span class=\"token function\">randomInt</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">3</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">5</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token number\">7</span><span class=\"token punctuation\">:</span>\n        dx <span class=\"token operator\">=</span> <span class=\"token function\">randomInt</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n    p<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> dx\n    p<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> y <span class=\"token operator\">+</span> dy\n    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">putImageData</span><span class=\"token punctuation\">(</span>imgData<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentFrame <span class=\"token operator\">></span> endFrame<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    currentFrame <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">animate</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> particals<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h3 id=\"demo\"><a href=\"#demo\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h3>\n<p>就把我的 F22 变消失吧. 这是一张 500*300 的扣掉背景的图, 点击蒸发!</p>\n<script data-inline-script=\"data-inline-script\">\nlet currentFrame = 0\nlet endFrame = 30\nlet img = new Image()\nimg.src = '/assets/image/infinity-gauntlet-effect/target.png'\nimg.onload = function() {\n  img.loaded = true\n}\nfunction randomInt(low, high) {\n  let factor = Math.random()\n  return (factor * low + factor * high) | 0\n}\nfunction clearCanvas(ctx) {\n  let canvas = ctx.canvas\n  ctx.clearRect(0, 0, canvas.width, canvas.height)\n}\nfunction clapData(x, y, w, h, ow, oh, data) {\n  let result = new Uint8ClampedArray(w * h * 4)\n  let leng = w * 4\n  for (let i = 0; i < h; i++) {\n    let j = ((y + i) * ow + x) * 4\n    let subArr = data.subarray(j, j + leng)\n    result.set(subArr, i * leng)\n  }\n  return result\n}\n\nwindow.$$$infinityGauntlet$$$ = {\n  img: img,\n  particalize: function(ctx, width = 2, height = 2) {\n    let canvas = ctx.canvas\n    let particals = []\n    let cols = rows = 0\n    let wholeImage = ctx.getImageData(0, 0, canvas.width, canvas.height)\n    for (let x = 0; x < canvas.width; x += width) {\n      cols += 1\n      for (let y = 0; y < canvas.height; y += height) {\n        rows += 1\n        // using getImageData() for every particals, slow\n        //\n        // let imgData = ctx.getImageData(x, y, width, height)\n        let data = clapData(x, y, width, height, canvas.width, canvas.height, wholeImage.data)\n        if (data[3] === 0) {\n          continue // ignore transparent particals\n        }\n        let imgData = new ImageData(data, width, height)\n        particals.push([x, y, imgData, rows, cols])\n      }\n    }\n    return [particals, cols, rows]\n  },\n  animate: function animate(ctx, particals, rows, reset, useAlpha) {\n    clearCanvas(ctx)\n    currentFrame += 1\n    let stripHeight = rows / 8\n    let alpha = (1 - currentFrame / endFrame) * 255\n    particals.forEach(p => {\n      let [x, y, imgData, row, col] = p\n      // no alpha altering would be much faster\n      if (useAlpha) {\n        for (var i = 3; i < imgData.data.length; i += 4) {\n          imgData.data[i] = alpha\n        }\n      }\n      let dx = 0, dy = randomInt(-15, -5)\n      switch (Math.floor(row / stripHeight)) {\n        case 0:\n        case 2:\n        case 4:\n        case 6:\n          dx = randomInt(-2, 8)\n          break\n        case 1:\n        case 3:\n        case 5:\n        case 7:\n          dx = randomInt(-8, 2)\n          break\n      }\n      p[0] = x + dx\n      p[1] = y + dy\n      if (p[0] > 0 && p[1] > 0) {\n        ctx.putImageData(imgData, p[0], p[1])\n      }\n    })\n    if (currentFrame > endFrame) {\n      currentFrame = 0\n      reset && reset()\n      return\n    }\n    requestAnimationFrame(() => animate(ctx, particals, rows, reset))\n  },\n  clearCanvas: function(ctx) {\n    let canvas = ctx.canvas\n    ctx.clearRect(0, 0, canvas.width, canvas.height)\n  },\n  draw: function draw(img, ctx) {\n    if (img.loaded) {\n      ctx.drawImage(img, 0, 0, 500, 300)\n    } else {\n      setTimeout(() => draw(img, ctx), 1000)\n    }\n  },\n  partition: function(ctx, layer) {\n    let canvas = ctx.canvas\n    let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height)\n    let result = new Array(layer)\n    for (let i = 0; i < layer; i++) {\n      result[i] = new ImageData(canvas.width, canvas.height)\n    }\n    let data = imgData.data\n    for (let i = 0; i < data.length; i += 4) {\n      let copy = result[randomInt(0, layer)]\n      copy.data.set(data.subarray(i, i + 4), i)\n    }\n    return result\n  }\n}\n\n</script>\n<p><canvas id=\"canvas\" width=\"500\" height=\"300\" style=\"cursor:pointer;\"></canvas></p>\n<script data-inline-script=\"data-inline-script\">\n\n(function() {\n  let canvas = document.getElementById('canvas'), context = canvas.getContext('2d')\n  let $ = $$$infinityGauntlet$$$\n  canvas.onclick = function() {\n    let [particals, cols, rows] = $.particalize(context, 4, 4)\n    $.animate(context, particals, rows, () => $.draw($.img, context))\n  }\n  $.draw($.img, context)\n})()\n\n</script>\n<p>从代码不难看出, 复杂度为 O(粒子数量)的线性关系, 粒子数量又为粒子宽度的平方, 所以这个方法的效率有显而易见的问题. 这里已经经过了几方面的优化:</p>\n<ul>\n<li>使用了很大的粒子(4 * 4)</li>\n<li>剔除掉透明的粒子 (无需特别精确)</li>\n<li>只调用一次<code class=\"language-text\">getImageData</code>, 然后手动剪切<code class=\"language-text\">Uint8ClampedArray</code>生成粒子的<code class=\"language-text\">ImageData</code></li>\n<li>不再写回超出边缘的粒子</li>\n<li>不去设置粒子的 Alpha 通道, 可显著提升效率</li>\n</ul>\n<p>不怕死的点下面粒子为 1*1, 开 alpha 渐变的效果, ☠️</p>\n<p><canvas id=\"canvas2\" width=\"500\" height=\"300\" style=\"cursor:pointer;\"></canvas></p>\n<script data-inline-script=\"data-inline-script\">\n\n(function() {\n  let canvas = document.getElementById('canvas2'), context = canvas.getContext('2d')\n  let $ = $$$infinityGauntlet$$$\n  canvas.onclick = function() {\n    let [particals, cols, rows] = $.particalize(context, 1, 1)\n    $.animate(context, particals, rows, () => $.draw($.img, context), true)\n  }\n  $.draw($.img, context)\n})()\n</script>\n<h3 id=\"sonow-what\"><a href=\"#sonow-what\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>So...now what?</h3>\n<p>很明显, 这样的方案虽然能达到基本效果, 但是效率没法让人满意, 后续优化的空间也基本没有, 基本是个死胡同. 于是又仔细观察了一下 Google 的效果, 发现:</p>\n<ul>\n<li>动画开始前有一个短暂但可见的卡顿, 目标边缘微小变化, 应该是目标的副本被绘制在了目标上层</li>\n<li>粒子确实是最小单位的</li>\n<li>动画是依次进行的, 这说明同时执行所有消失动画也有潜在的性能问题</li>\n<li>飘散的效果遵循一些特殊的 pattern, 并且不受边界限制</li>\n</ul>\n<p>于是猜想另一种实现: <strong>把目标按像素打印在多张层叠的 canvas 上, 然后 css 控制 canvas 的动画</strong></p>\n<p><img src=\"/assets/image/infinity-gauntlet-effect/partition.png\" alt=\"img\"></p>\n<h3 id=\"code\"><a href=\"#code\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code</h3>\n<p>代码中略去了一些不重要的细节.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// get layered canvases</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">partition</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> canvas <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>canvas\n  <span class=\"token keyword\">let</span> imgData <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getImageData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> layers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> layer<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    layers<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ImageData</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> imgData<span class=\"token punctuation\">.</span>data\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> copy <span class=\"token operator\">=</span> layers<span class=\"token punctuation\">[</span><span class=\"token function\">randomInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    copy<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">subarray</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> layers\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// animation: append layers to dom, set css target state</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">animate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> layers <span class=\"token operator\">=</span> <span class=\"token number\">20</span>\n  <span class=\"token keyword\">let</span> overlays <span class=\"token operator\">=</span> <span class=\"token function\">getCanvasNodes</span><span class=\"token punctuation\">(</span>layers<span class=\"token punctuation\">)</span>\n  canvas<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span>style <span class=\"token operator\">=</span> <span class=\"token string\">'position:relative;'</span>\n  overlays<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    canvas<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>nextSibling<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    canvas<span class=\"token punctuation\">.</span>style <span class=\"token operator\">=</span> <span class=\"token string\">'visibility:hidden;'</span>\n    <span class=\"token comment\">// shared css props, set elsewhere..</span>\n    <span class=\"token comment\">// position: absolute;</span>\n    <span class=\"token comment\">// left: 0;</span>\n    <span class=\"token comment\">// transition: all 2s;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">style</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      <span class=\"token template-string\"><span class=\"token string\">`user-select: none; pointer-events: none;transition: transform 1.5s ease-out 0s, opacity 1.5s ease-out; transform: rotate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>\n        <span class=\"token number\">10</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">deg) translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">50</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px) rotate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">deg); opacity: 0;`</span></span>\n    overlays<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">.</span>style <span class=\"token operator\">=</span> <span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h3 id=\"demo-1\"><a href=\"#demo-1\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h3>\n<p>Snap...</p>\n<p><canvas id=\"canvas3\" width=\"500\" height=\"300\" style=\"cursor:pointer;\"></canvas></p>\n<style>\n  canvas.dust {\n    position: absolute;\n    left: 0;\n    top: 0;\n    transition: all 2s;\n  }\n</style>\n<script data-inline-script=\"data-inline-script\">\n(function() {\n  let canvas = document.getElementById('canvas3'), context = canvas.getContext('2d')\n  let $ = $$$infinityGauntlet$$$\n  function getCanvasNodes(layers) {\n    let imgs = $.partition(context, layers)\n    return imgs.map(img => {\n      let can =  document.createElement('canvas')\n      can.className = \"dust\"\n      can.width = canvas.width\n      can.height = canvas.height\n      can.getContext('2d').putImageData(img, 0, 0)\n      return can\n    })\n  }\n  canvas.onclick = function() {\n    let layers = 30\n    let overlays = getCanvasNodes(layers)\n    canvas.parentNode.style = 'position:relative;'\n    overlays.forEach(n => {\n      canvas.parentNode.insertBefore(n, canvas.nextSibling);\n    })\n    function random() {\n      return (Math.random() - 0.5) * 2\n    }\n    function restore() {\n      canvas.style = ''\n      $.draw($.img, context)\n      overlays.forEach(l => {\n        l.style = ''\n        l.remove()\n      })\n    }\n    setTimeout(() => {\n      canvas.style = \"visibility:hidden;\"\n      let style = () => `user-select: none; pointer-events: none;transition: transform 1.5s ease-out 0s, opacity 1.5s ease-out; transform: rotate(${random()* 10}deg) translate(${random() * 100}px, ${random() * 50}px) rotate(${random()*5}deg); opacity: 0;`\n      overlays.forEach(l => l.style = style())\n      setTimeout(restore, 3000)\n    }, 500)\n  }\n  $.draw($.img, context)\n})()\n</script>\n<h4 id=\"css-赛高\"><a href=\"#css-%E8%B5%9B%E9%AB%98\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CSS 赛高!</h4>\n<p>很顺滑有没有. 经测, 分个百十来层都不会有卡顿问题, 分到 300 层有明显卡顿但也可接受, 远超上一个做法. 实际效果并不是层数越多越好, 而是应该有层次的飘散. 由于我采用了随机数分层所以再层数少的时候可能会有些点聚集的状况, 可以用均匀分配的方式来进一步减少层数. 不过, 比这些细节更重要的是, 对技术运用的<code class=\"language-text\">想象力</code>. 感谢 Google 工程师带来的启发!</p>","id":"3bc59082-bd79-53de-b6b0-58c0580fe439","fields":{"slug":"google的无限手套特效"},"frontmatter":{"date":"2019-06-11","title":"Google的无限手套特效","category":"Code","tags":["canvas","animation","小事儿"],"banner":"/assets/image/infinity-gauntlet-effect/banner.jpg"},"timeToRead":4},{"excerpt":"这是一道我经常在面试中会问的css题：如何实现Android平台上常见的，线条长度会变化的Loading组件： 这是一个我自己也答不出来的题, 问这个题的目的只是试探一下候选人是不是思维特别敏捷或者真的有深厚的css知识，而且也只当附加题助兴。如果真的思路正确甚至能完美答出，那真是遇见水平超出自己的人了。可惜并没有遇到，哪怕是思路靠边的也没有，看来此题并不是一个特别好的面试题。 第一次发现这个的纯css实现， 是在使用公司的 。具体Inspect的细节已经不急不清楚了，只记得是根据边框dash…","html":"<p>这是一道我经常在面试中会问的css题：如何实现Android平台上常见的，线条长度会变化的Loading组件：</p>\n<style>\n\n@keyframes spin {\n  to {transform:rotate(0deg);}\n  from {transform:rotate(360deg);}\n}\n\n.spinner {\n  animation: spin 5s linear infinite;\n}\n\n@keyframes dash {\n  0% {stroke-dashoffset: 0;}\n  100% {stroke-dashoffset: 860;}\n}\n\n.spinner circle {\n  cx: 50%;\n  cy: 50%;\n  r: 67px;\n  stroke-width: 5;\n  stroke-dasharray: 430 430;\n  fill: none;\n  stroke: orange;\n  animation: dash 3s linear infinite;\n}\n\n</style>\n<svg class=\"spinner\">\n  <circle></circle>\n</div>\n<p>这是一个我自己也答不出来的题, 问这个题的目的只是试探一下候选人是不是思维特别敏捷或者真的有深厚的css知识，而且也只当附加题助兴。如果真的思路正确甚至能完美答出，那真是遇见水平超出自己的人了。可惜并没有遇到，哪怕是思路靠边的也没有，看来此题并不是一个特别好的面试题。</p>\n<p>第一次发现这个的纯css实现， 是在使用公司的<code class=\"language-text\">JFrog artifactory</code>。具体Inspect的细节已经不急不清楚了，只记得是根据边框dash line的线段长短和offset来实现。当时真是觉得惊为天人，是那自我感觉良好，但突然发现一个事实让你感觉自己还是一个菜B的经历。</p>\n<p>过了这么久，问了这么多遍，竟然自己还没有实现过确实说不过去。既然上一篇blog解决了在markdown中写demo的问题，就趁热动动手。</p>\n<h3 id=\"思路\"><a href=\"#%E6%80%9D%E8%B7%AF\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>思路</h3>\n<p>刚见到实现的时候，一个最大的收获就是一个看似复杂的动作，其实只是两个简单的子动作的组合而已。再次提醒，拆分解决问题的重要性。如上，这个动画效果是两个子动画的叠加：</p>\n<ul>\n<li>整个圆形的旋转，匀速，反复。</li>\n<li>把圆的周长拉直，想象成一条轨道，一条实线在轨道上划过，反复。</li>\n</ul>\n<p>这样分解之后，问题就简单了很多。</p>\n<p>匀速旋转的css实现很简单：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@keyframes</span> spin</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">to</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>0deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\">from</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>360deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token selector\">.spinner</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">animation</span><span class=\"token punctuation\">:</span> spin 5s linear infinite<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>第二个看起来也不难，但涉及到具体实现方式就有问题了。本以为<code class=\"language-text\">border</code>的<code class=\"language-text\">dashed</code>会有类似的属性来控制offset，结果并没有，需要借助<code class=\"language-text\">svg</code>的<code class=\"language-text\">stroke-dashoffset</code>才可以：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@keyframes</span> dash</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">0%</span> <span class=\"token punctuation\">{</span><span class=\"token property\">stroke-dashoffset</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span>\n  <span class=\"token selector\">100%</span> <span class=\"token punctuation\">{</span><span class=\"token property\">stroke-dashoffset</span><span class=\"token punctuation\">:</span> 860<span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.spinner circle</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">cx</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">cy</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">r</span><span class=\"token punctuation\">:</span> 67px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">stroke-width</span><span class=\"token punctuation\">:</span> 5<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">stroke-dasharray</span><span class=\"token punctuation\">:</span> 430 430<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">fill</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">stroke</span><span class=\"token punctuation\">:</span> orange<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">animation</span><span class=\"token punctuation\">:</span> dash 3s linear infinite<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>spinner<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>circle</span> <span class=\"token attr-name\">cx</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>50%<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">cy</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>50%<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">r</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>67px<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>circle</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>这里注意offset和dasharray的数值，都跟spinner的半径有关: <code class=\"language-text\">dasharray</code>的实线和空白长度为周长， <code class=\"language-text\">dashoffset</code>的变化是两倍的周长。 于是就有了开头的效果。</p>\n<p>最初在尝试写这个效果的时候，我在<code class=\"language-text\">keyframe</code>中使用的是<code class=\"language-text\">stroke-dasharray</code>而非<code class=\"language-text\">stroke-dashoffset</code>。结果得到了如下的结果：</p>\n<style>\n\n@keyframes dash2 {\n  0% {stroke-dasharray: 430, 0;}\n  50% {stroke-dasharray: 0, 430;}\n  100% {stroke-dasharray: 430, 0;}\n}\n\n.spinner circle.demo2 {\n  cx: 50%;\n  cy: 50%;\n  r: 67px;\n  stroke-width: 5;\n  stroke-dasharray: 430, 430;\n  fill: none;\n  stroke: orange;\n  animation: dash2 3s linear infinite;\n}\n\n</style>\n<svg class=\"spinner\">\n  <circle class=\"demo2\"></circle>\n</div>\n<p>很明显线段在伸长时的方向不对。但如果调整一下旋转方向，或加快速度，又是另一番风味：</p>\n<style>\n.spinner-1,.spinner-2 {\n  animation: spin 1s linear infinite;\n}\n\n@keyframes dash3 {\n  0% {stroke-dasharray: 430, 0;}\n  66% {stroke-dasharray: 0, 430;}\n  100% {stroke-dasharray: 430, 0;}\n}\n\n@keyframes dash4 {\n  0% {stroke-dasharray: 0, 430;}\n  33% {stroke-dasharray: 430, 0;}\n  100% {stroke-dasharray: 0, 430;}\n}\n\n\n.spinner-1 circle {\n  cx: 50%;\n  cy: 50%;\n  r: 67px;\n  stroke-width: 5;\n  stroke-dasharray: 430 430;\n  fill: none;\n  stroke: orange;\n  animation: dash3 1s linear infinite;\n}\n.spinner-2 circle {\n  cx: 50%;\n  cy: 50%;\n  r: 67px;\n  stroke-width: 5;\n  stroke-dasharray: 430 430;\n  fill: none;\n  stroke: pink;\n  animation: dash4 1s linear infinite;\n}\n\n</style>\n<svg class=\"spinner-1\">\n  <circle></circle>\n</svg>\n<svg class=\"spinner-2\">\n  <circle></circle>\n</svg>\n<p>在这个框架下面，通过调整各种参数还是能得到很多意想不到的效果。网上还搜到<a href=\"https://codepen.io/ingomc/pen/ONrMqe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">一个spinner的css实现合集</a>，其中还包括不用svg实现的相同效果和利用<code class=\"language-text\">box-shadow</code>实现圆点组成的spinner，也很是更新认知。</p>","id":"934fd1e8-9080-508c-a447-b15ca8b7b157","fields":{"slug":"小事儿-android风格-loading-indicator-spinner"},"frontmatter":{"date":"2019-04-17","title":"小事儿: Android风格Loading Indicator(Spinner)","category":"Code","tags":["css","animation","小事儿"],"banner":"/assets/image/spinner.png"},"timeToRead":1},{"excerpt":"4 月 1 号打开了 StackOverflow, 看见满屏幕中二元素还以为自己走错了板块. 后来才想到愚人节的事情. 除了独角兽和超 gay 配色, 还有个鼠标下雪的效果还行, 就想着做做看. 思路 目标区域监听 事件, 获取鼠标位置. 图形: canvas 还是 DOM? 仔细看原实现, 雪花其实就是 * 号. 这样 DOM 会方便一些, 但 canvas 也不是不行. 动画: 动画部分由 , 和 x, y…","html":"<p>4 月 1 号打开了 StackOverflow, 看见满屏幕中二元素还以为自己走错了板块. 后来才想到愚人节的事情. 除了独角兽和超 gay 配色, 还有个鼠标下雪的效果还行, 就想着做做看.</p>\n<h3 id=\"思路\"><a href=\"#%E6%80%9D%E8%B7%AF\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>思路</h3>\n<ul>\n<li>目标区域监听<code class=\"language-text\">mousemove</code>事件, 获取鼠标位置.</li>\n<li>图形: canvas 还是 DOM? 仔细看原实现, 雪花其实就是*号. 这样 DOM 会方便一些, 但 canvas 也不是不行.</li>\n<li>动画: 动画部分由<code class=\"language-text\">fade out</code>, 和 x, y 轴两个方向的移动组成, 原实现并没有太复杂的诸如抖动, 动画曲线之类效果, 也没太大必要. 这一部分 css 可以实现, 问题是要不要利用<code class=\"language-text\">transition</code>, 用的话代码上简单一点, 不用的话可以精细控制做点其他效果.</li>\n</ul>\n<h3 id=\"搞\"><a href=\"#%E6%90%9E\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>搞</h3>\n<hr>\n<h4 id=\"dom\"><a href=\"#dom\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DOM</h4>\n<p>找一个区域, 盛放雪花元素. 再放一个雪花的模板, 克隆用.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>playground<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 500px<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 500px<span class=\"token punctuation\">;</span> <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> lightgrey<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>snowflake-template<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>snowflake<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>*<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>一些默认的 css 属性, 主要是控制雪花 sprite.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style language-css\">\n  <span class=\"token selector\">.snowflake</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> fixed<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">z-index</span><span class=\"token punctuation\">:</span> 861112<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> all 2s<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">opacity</span><span class=\"token punctuation\">:</span> 1<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">pointer-events</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\">#playground .snowflake</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<hr>\n<h4 id=\"js\"><a href=\"#js\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JS</h4>\n<p>准备工作</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> <span class=\"token constant\">COLORS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> playground <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'playground'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'snowflake-template'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">onMouseMove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// todo</span>\n<span class=\"token punctuation\">}</span>\n\nplayground<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mousemove'</span><span class=\"token punctuation\">,</span> onMouseMove<span class=\"token punctuation\">)</span></code></pre></div>\n<p>然后实现<code class=\"language-text\">onMouseMove</code>, 要做的事情就是, 1, 从模板复制一个雪花出来, 塞到容器里 2, 添加相关 css 属性. 3, 一定时间后摘除雪花元素. 考虑性能这个方法可做<code class=\"language-text\">throttle</code>, 这里略过.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">onMouseMove</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> color <span class=\"token operator\">=</span> <span class=\"token constant\">COLORS</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> snowflake <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token function\">cloneNode</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  snowflake<span class=\"token punctuation\">.</span><span class=\"token function\">removeAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  playground<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>snowflake<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  snowflake<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>cssText <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n    top: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>evt<span class=\"token punctuation\">.</span>clientY<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px;\n    left:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>evt<span class=\"token punctuation\">.</span>clientX<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px;\n    color: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>color<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;\n  `</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    snowflake<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>opacity <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    snowflake<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transform <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`scale(.4) translate3d(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span> <span class=\"token operator\">-</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">200</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">280</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px, 0)`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    snowflake<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>值得注意的是, <code class=\"language-text\">opacity</code>和<code class=\"language-text\">transform</code>是通过<code class=\"language-text\">setTimeout</code>另外加到元素上, 这样可以使<code class=\"language-text\">transition</code>生效. 这里也可以用<code class=\"language-text\">setInterval</code>或<code class=\"language-text\">requestAnimationFrame</code>来控制, 各个数值亦可以根据效果调整.</p>\n<h3 id=\"demo\"><a href=\"#demo\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h3>\n<div id=\"playground\">\n  hover me!\n</div>\n<style>\n\n  #playground {\n    width: 500px;\n    height: 500px;\n    background: lightgrey;\n    color: white;\n    font-size: 30px;\n    text-align: center;\n    padding-top: 200px;\n  }\n  .snowflake {\n    display: none;\n    position: fixed;\n    z-index: 861112;\n    transition: all 2s;\n    opacity: 1;\n    pointer-events: none;\n  }\n  #playground .snowflake {\n    display: block;\n  }\n</style>\n<p><span id=\"snowflake-template\" class=\"snowflake\">*</span></p>\n<script data-inline-script=\"data-inline-script\">\n\n  let COLORS = [\"#D61C59\", \"#E7D84B\", \"#1B8798\"]\n  let playground = document.getElementById('playground')\n  let template = document.getElementById('snowflake-template')\n\n  function onMouseMove(evt) {\n    let color = COLORS[(Math.random() * 3) | 0]\n    let snowflake = template.cloneNode(true)\n    snowflake.removeAttribute('id')\n    playground.appendChild(snowflake)\n    snowflake.style.cssText = `\n      top: ${evt.clientY}px;\n      left:${evt.clientX}px;\n      color: ${color};\n    `\n    setTimeout(() => {\n      snowflake.style.opacity = 0\n      snowflake.style.transform = `scale(.4) translate3d(${(.5 - Math.random()) * 200}px, ${Math.random() * 280}px, 0)`\n    })\n    setTimeout(() => {\n      snowflake.remove()\n    }, 2000)\n  }\n\n  playground.addEventListener('mousemove', onMouseMove)\n\n</script>\n<h3 id=\"跟原实现的对比\"><a href=\"#%E8%B7%9F%E5%8E%9F%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AF%B9%E6%AF%94\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>跟原实现的对比</h3>\n<p>上面的 demo, 颜色是借用的, 其他都是按照效果实现. 原实现其实已经<a href=\"https://stackapps.com/questions/8287/2019-april-fools-day-retro-theme\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">公布在了 StackOverflow 上</a>. 对比下来主要区别是, 原实现没用<code class=\"language-text\">transition</code>而是上面提到的<code class=\"language-text\">requestAnimationFrame</code>方案, 效果上确实没有 demo 中的卡顿(原因应该是是 demo 中的第一个<code class=\"language-text\">setTimeout</code>的频繁 DOM 操作).</p>","id":"976f7a3a-2f0c-5946-b5bc-1e3ee138d18c","fields":{"slug":"小事儿-stackoverflow愚人节特效"},"frontmatter":{"date":"2019-04-03","title":"小事儿: stackoverflow愚人节特效","category":"Code","tags":["css","stackoverflow","animation","小事儿"],"banner":"/assets/image/stackoverflow-aprilfools-theme.png"},"timeToRead":2},{"excerpt":"在测试前端解析一个比较大的 Excel 文件时候, 发现我们的 button 的 spinner 卡住了. 印象中即使线程阻塞了, 有些 GPU 加速的东西依然应该有效. 怀疑又是某种 css in js 的弱智用法(没错, 我就是讨厌 css in js). 查看了一下元素发现是用了 svg 的 animateTransform . 写法上面感觉跟 css 差不多都是一堆  +  . 难道这样也会阻塞吗? 所以做了个测试 结果是, 虽然长得像, 但 css animation…","html":"<p>在测试前端解析一个比较大的 Excel 文件时候, 发现我们的 button 的 spinner 卡住了. 印象中即使线程阻塞了, 有些 GPU 加速的东西依然应该有效. 怀疑又是某种 css in js 的弱智用法(没错, 我就是讨厌 css in js). 查看了一下元素发现是用了 svg 的<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animateTransform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">animateTransform</a>. 写法上面感觉跟 css 差不多都是一堆<code class=\"language-text\">transform</code> + <code class=\"language-text\">rotate</code>. 难道这样也会阻塞吗?</p>\n<p><a href=\"https://jsbin.com/wodenoxaku/1/edit?html,css,output\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">所以做了个测试</a></p>\n<p><img src=\"/assets/image/css-svg-anim/demo.gif\" alt=\"demo\"></p>\n<p>结果是, 虽然长得像, 但 css animation 还是一等公民, 并不像<a href=\"https://stackoverflow.com/questions/25233248/gpu-accelerated-css-animation-vs-svg-native-animations\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stack Overflow 某问题</a>的评论所说<code class=\"language-text\">They are the same. UAs generally have one animation engine which does both kinds of animation</code>. css 得到了 GPU 加速但 svg 会被线程阻塞影响.</p>\n<p>由于动画, GPU 加速等等属于浏览器的自主裁量行为了, 所以测试结果并不代表什么确切的东西. 有可能未来某时刻打开测试连接结果就不一样了呢. 只能说写下本文时, 浏览器对 css 的优化优先级更高, 实践中应优先使用吧.</p>\n<hr>\n<p>如果链接挂了的话, 这是代码:</p>\n<h3 id=\"html\"><a href=\"#html\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>html</h3>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>width=device-width<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>JS Bin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>CSS spinner<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>css-spinner<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>Svg spinner<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>50<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>50<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">viewBox</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>0 0 44 44<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>defs</span><span class=\"token punctuation\">></span></span>Ç\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>linearGradient</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>a<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>stop</span> <span class=\"token attr-name\">stop-color</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#FF4F42<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">offset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>0%<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>stop</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>stop</span> <span class=\"token attr-name\">stop-color</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#FF8E3C<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">offset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>100%<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>stop</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>linearGradient</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>defs</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>g</span> <span class=\"token attr-name\">transform</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>translate(3 3)<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>none<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">fill-rule</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>evenodd<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>path</span> <span class=\"token attr-name\">d</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>M36 18c0-9.94-8.06-18-18-18<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">stroke</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>#000<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">stroke-width</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>5<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">stroke-linecap</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>round<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">transform</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>rotate(217.117 18 18)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>animateTransform</span> <span class=\"token attr-name\">attributeName</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>transform<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>rotate<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">from</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>0 18 18<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">to</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>360 18 18<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dur</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>2s<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">repeatCount</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>indefinite<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>animateTransform</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>path</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>g</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onclick</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>for (var i = 0; i &lt; 100000; i++) console.log(i)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Blocking action<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3 id=\"css\"><a href=\"#css\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>css</h3>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@keyframes</span> spin</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">from</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">-webkit-transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>0deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>0deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\">to</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">-webkit-transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>359deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>359deg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.css-spinner</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">animation</span><span class=\"token punctuation\">:</span> spin 2s infinite linear<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 50px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 50px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-radius</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border</span><span class=\"token punctuation\">:</span> 6px solid black<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-right-color</span><span class=\"token punctuation\">:</span> transparent<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-bottom-color</span><span class=\"token punctuation\">:</span> transparent<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">border-top-color</span><span class=\"token punctuation\">:</span> transparent<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">margin-left</span><span class=\"token punctuation\">:</span> 30px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">button</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">margin-top</span><span class=\"token punctuation\">:</span> 30px<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 30px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","id":"1e2096f5-8829-54de-ba90-e6a8c261a425","fields":{"slug":"小事儿-线程阻塞对css-animation和svg-animation的影响"},"frontmatter":{"date":"2019-03-06","title":"小事儿: 线程阻塞对css animation和svg animation的影响","category":"Code","tags":["css","svg","animation","小事儿"],"banner":"/assets/image/css-svg-anim/spinner-blocked.png"},"timeToRead":2}],"tagName":"animation"}}}